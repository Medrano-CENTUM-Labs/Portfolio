<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arquitecto de Portafolios: Simulador Macroecon√≥mico Interactivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { 
            position: relative; 
            width: 100%; 
            height: 50vh; 
            max-height: 500px;
        }
        @media (min-width: 1024px) {
            .chart-container { height: 65vh; }
        }
        /* Custom scrollbar for sidebars */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
    <!-- Chosen Palette: Slate & Emerald - Professional, financial, trustworthy. 
         Slate (Blue-Greys) for UI structure, Emerald for positive actions, 
         Distinct colors for chart lines. -->
    
    <!-- Application Structure Plan:
         1. Layout: Three-column layout (Left: Controls, Center: Viz, Right: Analysis).
         2. Logic: Central 'State' object drives the Chart.js instance.
         3. Interaction: Filter changes triggers data recalculation -> Chart update -> Metrics update.
         4. Context: Historical data is pre-loaded in JS arrays (simulated from 1900-2026 trends).
    -->
    
    <!-- Visualization & Content Choices:
         1. Main Viz: Line Chart (Chart.js) - Best for temporal evolution.
         2. Indicators: Separate axis or overlaid for Context (Inflation/Rates).
         3. Assets/Portfolios: Normalized growth (Base 100) to allow comparison.
         4. NO SVG/Mermaid: All icons are Unicode or CSS shapes.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 flex-shrink-0 z-20 shadow-sm">
        <div class="flex items-center gap-2">
            <span class="text-2xl">üèõÔ∏è</span>
            <div>
                <h1 class="font-bold text-xl tracking-tight text-slate-900 leading-none">Arquitecto de Portafolios</h1>
                <p class="text-xs text-slate-500 mt-1">Simulaci√≥n Estrat√©gica & An√°lisis Macro</p>
            </div>
        </div>
        <div class="flex gap-4">
            <button onclick="toggleGlossary()" class="text-sm font-medium text-slate-600 hover:text-emerald-600 transition-colors flex items-center gap-1">
                <span>üìö</span> Glosario
            </button>
        </div>
    </header>

    <!-- Main Content Grid -->
    <main class="flex-1 flex flex-col lg:flex-row overflow-hidden">
        
        <!-- LEFT SIDEBAR: FILTERS -->
        <aside class="w-full lg:w-1/5 bg-white border-r border-slate-200 overflow-y-auto p-5 flex flex-col gap-8 shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10">
            
            <!-- Context Selection -->
            <section>
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider">1. Contexto Macro</h2>
                    <span class="text-xs text-emerald-600 cursor-pointer hover:underline" id="resetContext">Reset</span>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Escenario Hist√≥rico</label>
                        <select id="scenarioSelect" class="w-full bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2.5">
                            <option value="2020s">Actualidad & Previsi√≥n (2020-2026)</option>
                            <option value="2008">Gran Recesi√≥n (2007-2010)</option>
                            <option value="2000">Burbuja Dotcom (1999-2003)</option>
                            <option value="1970">La Gran Inflaci√≥n (1970-1980)</option>
                            <option value="1929">Gran Depresi√≥n (1929-1935)</option>
                            <option value="custom">‚öôÔ∏è Personalizado</option>
                        </select>
                    </div>

                    <!-- Custom Controls (Hidden by default) -->
                    <div id="customControls" class="hidden space-y-4 pt-2 border-t border-slate-100">
                        <p class="text-xs text-slate-500 italic">Ajusta variables para simular un escenario hipot√©tico.</p>
                        <div>
                            <label class="flex justify-between text-xs font-medium text-slate-600">
                                <span>Inflaci√≥n (CPI)</span>
                                <span id="val-inflation">3%</span>
                            </label>
                            <input type="range" min="-2" max="15" step="0.5" value="3" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-600" oninput="updateCustomParam('inflation', this.value)">
                        </div>
                        <div>
                            <label class="flex justify-between text-xs font-medium text-slate-600">
                                <span>Tipos de Inter√©s</span>
                                <span id="val-rates">4%</span>
                            </label>
                            <input type="range" min="0" max="20" step="0.5" value="4" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-600" oninput="updateCustomParam('rates', this.value)">
                        </div>
                        <div>
                            <label class="flex justify-between text-xs font-medium text-slate-600">
                                <span>Precio Oro ($/oz)</span>
                                <span id="val-gold">2000</span>
                            </label>
                            <input type="range" min="1000" max="3000" step="50" value="2000" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-600" oninput="updateCustomParam('gold', this.value)">
                        </div>
                        <div>
                            <label class="flex justify-between text-xs font-medium text-slate-600">
                                <span>Sentimiento (VIX)</span>
                                <span id="val-vix">20</span>
                            </label>
                            <input type="range" min="10" max="80" step="1" value="20" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-600" oninput="updateCustomParam('vix', this.value)">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Portfolio Selection -->
            <section>
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">2. Portfolios Modelo</h2>
                <div class="space-y-2">
                    <!-- Standard -->
                    <label class="flex items-center space-x-2 p-2 rounded hover:bg-slate-50 cursor-pointer transition-colors group">
                        <input type="checkbox" name="portfolio" value="goldenButterfly" class="form-checkbox text-emerald-600 rounded focus:ring-emerald-500 h-4 w-4">
                        <div class="flex flex-col">
                            <span class="text-sm font-semibold text-slate-700 group-hover:text-emerald-700">Golden Butterfly</span>
                            <span class="text-[10px] text-slate-400">Estabilidad y Crecimiento</span>
                        </div>
                    </label>

                    <label class="flex items-center space-x-2 p-2 rounded hover:bg-slate-50 cursor-pointer transition-colors group">
                        <input type="checkbox" name="portfolio" value="classic6040" class="form-checkbox text-emerald-600 rounded focus:ring-emerald-500 h-4 w-4">
                        <div class="flex flex-col">
                            <span class="text-sm font-semibold text-slate-700 group-hover:text-emerald-700">Cl√°sico 60/40</span>
                            <span class="text-[10px] text-slate-400">El est√°ndar industrial</span>
                        </div>
                    </label>

                    <label class="flex items-center space-x-2 p-2 rounded hover:bg-slate-50 cursor-pointer transition-colors group">
                        <input type="checkbox" name="portfolio" value="permanent" class="form-checkbox text-emerald-600 rounded focus:ring-emerald-500 h-4 w-4">
                        <div class="flex flex-col">
                            <span class="text-sm font-semibold text-slate-700 group-hover:text-emerald-700">Permanent Portfolio</span>
                            <span class="text-[10px] text-slate-400">Defensivo total (Harry Browne)</span>
                        </div>
                    </label>

                    <!-- New/Added -->
                    <label class="flex items-center space-x-2 p-2 rounded hover:bg-slate-50 cursor-pointer transition-colors group">
                        <input type="checkbox" name="portfolio" value="allWeather" class="form-checkbox text-emerald-600 rounded focus:ring-emerald-500 h-4 w-4">
                        <div class="flex flex-col">
                            <span class="text-sm font-semibold text-slate-700 group-hover:text-emerald-700">All Weather (Dalio)</span>
                            <span class="text-[10px] text-slate-400">Paridad de riesgo</span>
                        </div>
                    </label>

                    <label class="flex items-center space-x-2 p-2 rounded hover:bg-slate-50 cursor-pointer transition-colors group">
                        <input type="checkbox" name="portfolio" value="pinwheel" class="form-checkbox text-emerald-600 rounded focus:ring-emerald-500 h-4 w-4">
                        <div class="flex flex-col">
                            <span class="text-sm font-semibold text-slate-700 group-hover:text-emerald-700">Pinwheel</span>
                            <span class="text-[10px] text-slate-400">Global y diversificado</span>
                        </div>
                    </label>

                     <label class="flex items-center space-x-2 p-2 rounded hover:bg-slate-50 cursor-pointer transition-colors group">
                        <input type="checkbox" name="portfolio" value="goldenRatio" class="form-checkbox text-emerald-600 rounded focus:ring-emerald-500 h-4 w-4">
                        <div class="flex flex-col">
                            <span class="text-sm font-semibold text-slate-700 group-hover:text-emerald-700">Golden Ratio</span>
                            <span class="text-[10px] text-slate-400">Proporci√≥n √°urea (42/26/16/10/6)</span>
                        </div>
                    </label>
                </div>
            </section>

            <!-- Asset Selection -->
            <section id="assetSection" class="transition-opacity duration-300">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider">3. Clases de Activos</h2>
                    <span id="assetWarning" class="text-[10px] text-orange-500 hidden">‚ö†Ô∏è M√°x 1 portfolio para editar</span>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <label class="flex items-center space-x-2 cursor-pointer p-1 rounded hover:bg-slate-50">
                        <input type="checkbox" name="asset" value="stocksUS" class="form-checkbox text-blue-600 rounded h-3.5 w-3.5">
                        <span class="text-xs text-slate-600">R.V. EEUU</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-1 rounded hover:bg-slate-50">
                        <input type="checkbox" name="asset" value="stocksIntl" class="form-checkbox text-blue-500 rounded h-3.5 w-3.5">
                        <span class="text-xs text-slate-600">R.V. Global</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-1 rounded hover:bg-slate-50">
                        <input type="checkbox" name="asset" value="bondsLong" class="form-checkbox text-indigo-500 rounded h-3.5 w-3.5">
                        <span class="text-xs text-slate-600">Bonos L.P.</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-1 rounded hover:bg-slate-50">
                        <input type="checkbox" name="asset" value="bondsShort" class="form-checkbox text-indigo-400 rounded h-3.5 w-3.5">
                        <span class="text-xs text-slate-600">Bonos C.P.</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-1 rounded hover:bg-slate-50">
                        <input type="checkbox" name="asset" value="gold" class="form-checkbox text-amber-500 rounded h-3.5 w-3.5">
                        <span class="text-xs text-slate-600">Oro</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-1 rounded hover:bg-slate-50">
                        <input type="checkbox" name="asset" value="commodities" class="form-checkbox text-orange-600 rounded h-3.5 w-3.5">
                        <span class="text-xs text-slate-600">Materias P.</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-1 rounded hover:bg-slate-50">
                        <input type="checkbox" name="asset" value="reits" class="form-checkbox text-teal-600 rounded h-3.5 w-3.5">
                        <span class="text-xs text-slate-600">Real Estate</span>
                    </label>
                     <label class="flex items-center space-x-2 cursor-pointer p-1 rounded hover:bg-slate-50">
                        <input type="checkbox" name="asset" value="crypto" class="form-checkbox text-purple-600 rounded h-3.5 w-3.5">
                        <span class="text-xs text-slate-600">Bitcoin (Sim)</span>
                    </label>
                </div>
            </section>
        </aside>

        <!-- CENTER: VISUALIZATION -->
        <section class="flex-1 flex flex-col bg-white relative">
            <div class="flex-1 p-4 lg:p-8 flex flex-col items-center justify-center bg-slate-50/50 relative">
                
                <!-- Intro Text for Context -->
                <div id="chartHeader" class="w-full max-w-4xl mb-4">
                    <h2 id="chartTitle" class="text-xl font-bold text-slate-800">Evoluci√≥n de Mercado</h2>
                    <p id="chartSubtitle" class="text-sm text-slate-500 mt-1">Selecciona un escenario para comenzar la simulaci√≥n.</p>
                </div>

                <!-- Chart Container -->
                <div class="chart-container w-full max-w-5xl bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <canvas id="mainChart"></canvas>
                </div>

                <!-- Time Range / Slider Indicator (Visual Only) -->
                <div class="w-full max-w-5xl mt-4 px-4 hidden lg:block">
                     <div class="relative pt-1">
                        <div class="flex mb-2 items-center justify-between">
                            <div class="text-xs text-slate-400 uppercase font-bold">Inicio Periodo</div>
                            <div class="text-xs text-slate-400 uppercase font-bold">Fin Periodo</div>
                        </div>
                        <div class="overflow-hidden h-1 mb-4 text-xs flex rounded bg-slate-200">
                            <div id="progressBar" style="width: 100%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-emerald-500 transition-all duration-1000"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- RIGHT SIDEBAR: DETAILS -->
        <aside class="w-full lg:w-1/5 bg-white border-l border-slate-200 overflow-y-auto p-5 shadow-[-4px_0_24px_rgba(0,0,0,0.02)] z-10">
            
            <!-- Analysis Panel -->
            <div class="space-y-6">
                
                <!-- Period Summary -->
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-100">
                    <h3 class="text-sm font-bold text-slate-800 mb-2 flex items-center gap-2">
                        <span>üìä</span> An√°lisis del Periodo
                    </h3>
                    <p id="periodDescription" class="text-xs text-slate-600 leading-relaxed">
                        Selecciona un contexto hist√≥rico para ver el an√°lisis detallado de los eventos macroecon√≥micos y su impacto en los mercados.
                    </p>
                </div>

                <!-- Active Indicators (Legend & Toggles) -->
                <div>
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Indicadores Activos</h3>
                    <div id="indicatorsList" class="space-y-2">
                        <!-- Dynamic Content Generated by JS -->
                    </div>
                </div>

                <!-- Metrics Table -->
                <div>
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">M√©tricas de Rendimiento</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-xs text-left">
                            <thead class="text-slate-500 border-b border-slate-100">
                                <tr>
                                    <th class="pb-2 font-medium">Activo</th>
                                    <th class="pb-2 font-medium text-right">CAGR</th>
                                    <th class="pb-2 font-medium text-right">Vol</th>
                                </tr>
                            </thead>
                            <tbody id="metricsBody" class="text-slate-700">
                                <!-- Dynamic Rows -->
                            </tbody>
                        </table>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2 text-right">*Simulaci√≥n basada en datos hist√≥ricos</p>
                </div>

                <!-- Strategy Suggestion -->
                <div id="strategyTip" class="bg-emerald-50 border border-emerald-100 p-3 rounded-lg hidden">
                    <h4 class="text-xs font-bold text-emerald-800 mb-1">üí° Sugerencia T√°ctica</h4>
                    <p class="text-[11px] text-emerald-700 leading-snug" id="strategyText"></p>
                </div>

            </div>
        </aside>

    </main>

    <!-- Modal: Glossary -->
    <div id="glossaryModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white">
                <h2 class="text-xl font-bold text-slate-800">Glosario Financiero</h2>
                <button onclick="toggleGlossary()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <h3 class="font-bold text-emerald-700 text-sm">CAGR (Compound Annual Growth Rate)</h3>
                    <p class="text-sm text-slate-600">Tasa de Crecimiento Anual Compuesto. Mide el retorno de una inversi√≥n como si hubiera crecido a un ritmo constante anualmente. Suaviza la volatilidad para facilitar comparaciones.</p>
                </div>
                <div>
                    <h3 class="font-bold text-emerald-700 text-sm">Drawdown M√°ximo</h3>
                    <p class="text-sm text-slate-600">La mayor ca√≠da porcentual desde un pico hasta un valle antes de que se alcance un nuevo pico. Es una medida clave del riesgo de p√©rdida de capital.</p>
                </div>
                <div>
                    <h3 class="font-bold text-emerald-700 text-sm">Volatilidad (Desviaci√≥n Est√°ndar)</h3>
                    <p class="text-sm text-slate-600">Medida de cu√°nto var√≠a el precio de un activo respecto a su media. Una mayor volatilidad implica un mayor riesgo y una gama m√°s amplia de resultados posibles.</p>
                </div>
                <div>
                    <h3 class="font-bold text-emerald-700 text-sm">Ratio de Sharpe</h3>
                    <p class="text-sm text-slate-600">Mide el rendimiento ajustado al riesgo. Indica cu√°nto exceso de retorno se obtiene por cada unidad de volatilidad asumida. Cuanto m√°s alto, mejor.</p>
                </div>
                <hr class="border-slate-100 my-4">
                <div>
                    <h3 class="font-bold text-slate-800 text-sm mb-2">Portfolios Analizados</h3>
                    <ul class="list-disc list-inside text-sm text-slate-600 space-y-1">
                        <li><strong>Golden Butterfly:</strong> 20% Total Stock, 20% Small Cap Value, 20% Bonos LP, 20% Bonos CP, 20% Oro. Dise√±ado para crecimiento estable.</li>
                        <li><strong>Permanent Portfolio:</strong> 25% RV, 25% Bonos, 25% Cash, 25% Oro. Extremadamente defensivo.</li>
                        <li><strong>Classic 60/40:</strong> 60% RV, 40% Bonos. El est√°ndar de la industria, aunque sufre en periodos inflacionarios.</li>
                        <li><strong>All Weather (Ray Dalio):</strong> 30% RV, 40% Bonos LP, 15% Bonos MP, 7.5% Oro, 7.5% Commodities. Equilibrio de riesgo econ√≥mico.</li>
                        <li><strong>Pinwheel:</strong> Alta diversificaci√≥n (incluye REITs, Emergentes y Small Cap) para capturar primas de riesgo globales.</li>
                        <li><strong>Golden Ratio:</strong> 42% RV, 26% Bonos, 16% Oro, 10% REITs, 6% Cash. Basado en proporciones matem√°ticas para balancear volatilidad.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        /**
         * DATA ENGINE
         * Simulates historical data curves for demonstration purposes since live API is not available.
         * Data points are normalized approximations of historical trends.
         */

        const HISTORICAL_DATA = {
            '2020s': {
                name: "Actualidad & Previsi√≥n (2020-2026)",
                description: "Desde el choque del COVID-19 hasta la actual recuperaci√≥n inflacionaria y las proyecciones para 2026. Caracterizado por alta volatilidad, intervenci√≥n monetaria masiva y tensiones geopol√≠ticas.",
                years: [2020, 2021, 2022, 2023, 2024, 2025, 2026],
                context: {
                    inflation: [1.2, 4.7, 8.0, 4.1, 3.1, 2.8, 2.5], // % CPI
                    rates: [0.25, 0.25, 4.5, 5.5, 5.0, 4.0, 3.5],   // % Fed Funds
                    vix: [35, 18, 25, 16, 14, 18, 22]               // Volatility Index
                },
                assets: {
                    // Normalized to 100 at start
                    stocksUS: [100, 126, 102, 128, 145, 155, 165],
                    stocksIntl: [100, 110, 95, 108, 115, 122, 128],
                    bondsLong: [100, 95, 70, 72, 78, 85, 92],
                    bondsShort: [100, 100, 101, 105, 110, 114, 118],
                    gold: [100, 105, 105, 118, 130, 145, 160],
                    commodities: [100, 130, 150, 130, 125, 135, 140],
                    reits: [100, 135, 100, 110, 115, 125, 132],
                    crypto: [100, 300, 100, 250, 400, 500, 600]
                }
            },
            '2008': {
                name: "La Gran Recesi√≥n (2007-2010)",
                description: "Colapso del mercado inmobiliario y crisis bancaria global. La renta variable sufri√≥ ca√≠das del 50%, mientras que los bonos del tesoro actuaron como refugio seguro.",
                years: [2007, 2008, 2009, 2010],
                context: {
                    inflation: [2.8, 3.8, -0.4, 1.6],
                    rates: [5.25, 0.25, 0.25, 0.25],
                    vix: [18, 60, 25, 18]
                },
                assets: {
                    stocksUS: [100, 63, 79, 90],
                    stocksIntl: [100, 58, 75, 82],
                    bondsLong: [100, 120, 105, 115],
                    bondsShort: [100, 105, 106, 107],
                    gold: [100, 105, 125, 150],
                    commodities: [100, 60, 75, 85],
                    reits: [100, 60, 75, 95],
                    crypto: [0, 0, 0, 0] // Didn't exist/irrelevant
                }
            },
            '2000': {
                name: "Burbuja Dotcom (1999-2003)",
                description: "Explosi√≥n de valoraciones tecnol√≥gicas irracionales. El mercado general cay√≥ durante tres a√±os consecutivos, algo poco com√∫n. Los activos de valor (Value) y bonos protegieron el capital.",
                years: [1999, 2000, 2001, 2002, 2003],
                context: {
                    inflation: [2.2, 3.4, 2.8, 1.6, 2.3],
                    rates: [5.0, 6.5, 3.0, 1.25, 1.0],
                    vix: [25, 28, 30, 35, 20]
                },
                assets: {
                    stocksUS: [100, 90, 80, 62, 80],
                    stocksIntl: [100, 85, 70, 60, 80],
                    bondsLong: [100, 115, 120, 135, 138],
                    bondsShort: [100, 106, 112, 116, 118],
                    gold: [100, 95, 98, 115, 135],
                    commodities: [100, 110, 90, 105, 120],
                    reits: [100, 115, 125, 130, 160],
                    crypto: [0, 0, 0, 0, 0]
                }
            },
            '1970': {
                name: "La Gran Inflaci√≥n (1970-1980)",
                description: "Estanflaci√≥n: alto desempleo y alta inflaci√≥n. Las acciones tuvieron rendimientos reales negativos. El oro y las materias primas fueron los grandes ganadores.",
                years: [1970, 1972, 1974, 1976, 1978, 1980],
                context: {
                    inflation: [5.5, 3.2, 11.0, 5.8, 7.6, 13.5],
                    rates: [8.0, 4.0, 11.0, 5.0, 9.0, 18.0],
                    vix: [20, 15, 35, 18, 20, 25] // Estimated
                },
                assets: {
                    stocksUS: [100, 115, 80, 110, 115, 130], // Nominal gains, real losses
                    stocksIntl: [100, 120, 90, 115, 140, 160],
                    bondsLong: [100, 110, 105, 130, 125, 100], // Crushed by rates
                    bondsShort: [100, 110, 125, 140, 160, 200], // Keeping up with rates
                    gold: [100, 180, 350, 280, 450, 1200], // The big winner
                    commodities: [100, 120, 200, 180, 220, 300],
                    reits: [100, 110, 90, 120, 140, 180],
                    crypto: [0, 0, 0, 0, 0, 0]
                }
            },
            '1929': {
                name: "Gran Depresi√≥n (1929-1935)",
                description: "El mayor colapso econ√≥mico de la historia moderna. Deflaci√≥n masiva y ca√≠da del 89% en el Dow Jones. Solo el efectivo y los bonos del gobierno conservaron valor.",
                years: [1929, 1930, 1931, 1932, 1933, 1934, 1935],
                context: {
                    inflation: [0, -2.5, -9.0, -10.0, -5.0, 3.0, 2.0], // Deflation
                    rates: [6.0, 3.0, 2.0, 2.5, 1.5, 1.0, 1.0],
                    vix: [30, 40, 50, 80, 40, 30, 25] // Historical vol estimation
                },
                assets: {
                    stocksUS: [100, 70, 40, 20, 35, 38, 50],
                    stocksIntl: [100, 65, 35, 25, 35, 36, 45],
                    bondsLong: [100, 104, 98, 105, 106, 112, 115],
                    bondsShort: [100, 102, 104, 105, 106, 106, 106],
                    gold: [100, 100, 100, 100, 160, 160, 160], // Pegged then revalued in 1933
                    commodities: [100, 80, 60, 50, 65, 70, 75],
                    reits: [100, 80, 60, 40, 50, 55, 60], // Proxy
                    crypto: [0, 0, 0, 0, 0, 0, 0]
                }
            }
        };

        // Portfolio Compositions
        const PORTFOLIOS = {
            goldenButterfly: {
                name: "Golden Butterfly",
                color: '#d97706', // amber-600
                composition: { stocksUS: 0.2, stocksIntl: 0.0, bondsLong: 0.2, bondsShort: 0.2, gold: 0.2, smallCapVal: 0.2 } 
                // Note: Simplified logic, mapping SmallCapVal to StocksUS with a premium in calculating
            },
            classic6040: {
                name: "Cl√°sico 60/40",
                color: '#2563eb', // blue-600
                composition: { stocksUS: 0.4, stocksIntl: 0.2, bondsLong: 0.4, bondsShort: 0, gold: 0 }
            },
            permanent: {
                name: "Permanent Portfolio",
                color: '#4b5563', // gray-600
                composition: { stocksUS: 0.25, bondsLong: 0.25, bondsShort: 0.25, gold: 0.25 }
            },
            allWeather: {
                name: "All Weather (Dalio)",
                color: '#16a34a', // green-600
                composition: { stocksUS: 0.3, bondsLong: 0.4, bondsShort: 0.15, gold: 0.075, commodities: 0.075 }
            },
            pinwheel: {
                name: "Pinwheel",
                color: '#9333ea', // purple-600
                composition: { stocksUS: 0.15, stocksIntl: 0.25, reits: 0.15, bondsShort: 0.25, gold: 0.1, commodities: 0.1 }
            },
            goldenRatio: {
                name: "Golden Ratio",
                color: '#ea580c', // orange-600
                composition: { stocksUS: 0.21, stocksIntl: 0.21, bondsLong: 0.26, reits: 0.1, gold: 0.16, bondsShort: 0.06 }
            }
        };

        const ASSET_META = {
            stocksUS: { name: "R.V. EEUU", color: '#60a5fa' },
            stocksIntl: { name: "R.V. Global", color: '#3b82f6' },
            bondsLong: { name: "Bonos Largo Plazo", color: '#6366f1' },
            bondsShort: { name: "Bonos Corto Plazo", color: '#818cf8' },
            gold: { name: "Oro", color: '#fbbf24' },
            commodities: { name: "Materias Primas", color: '#ea580c' },
            reits: { name: "Real Estate", color: '#14b8a6' },
            crypto: { name: "Bitcoin (Sim)", color: '#9333ea' }
        };

        // State Management
        let appState = {
            context: '2020s',
            customParams: { inflation: 3, rates: 4, gold: 2000, vix: 20 },
            selectedPortfolios: [],
            selectedAssets: []
        };

        let chartInstance = null;

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            setupEventListeners();
            updateUI();
        });

        function setupEventListeners() {
            // Context Selector
            document.getElementById('scenarioSelect').addEventListener('change', (e) => {
                const val = e.target.value;
                appState.context = val;
                if (val === 'custom') {
                    document.getElementById('customControls').classList.remove('hidden');
                } else {
                    document.getElementById('customControls').classList.add('hidden');
                }
                updateUI();
            });

            // Reset Context
            document.getElementById('resetContext').addEventListener('click', () => {
                document.getElementById('scenarioSelect').value = '2020s';
                appState.context = '2020s';
                document.getElementById('customControls').classList.add('hidden');
                updateUI();
            });

            // Portfolios
            document.querySelectorAll('input[name="portfolio"]').forEach(cb => {
                cb.addEventListener('change', () => {
                    const selected = Array.from(document.querySelectorAll('input[name="portfolio"]:checked')).map(c => c.value);
                    appState.selectedPortfolios = selected;
                    
                    // Logic: If > 1 portfolio, disable assets
                    const assetInputs = document.querySelectorAll('input[name="asset"]');
                    const assetSection = document.getElementById('assetSection');
                    const warning = document.getElementById('assetWarning');

                    if (selected.length > 1) {
                        assetInputs.forEach(i => { i.checked = false; i.disabled = true; });
                        appState.selectedAssets = [];
                        assetSection.classList.add('opacity-50');
                        warning.classList.remove('hidden');
                    } else {
                        assetInputs.forEach(i => i.disabled = false);
                        assetSection.classList.remove('opacity-50');
                        warning.classList.add('hidden');
                    }
                    updateUI();
                });
            });

            // Assets
            document.querySelectorAll('input[name="asset"]').forEach(cb => {
                cb.addEventListener('change', () => {
                    appState.selectedAssets = Array.from(document.querySelectorAll('input[name="asset"]:checked')).map(c => c.value);
                    updateUI();
                });
            });
        }

        function updateCustomParam(key, val) {
            appState.customParams[key] = parseFloat(val);
            document.getElementById(`val-${key}`).innerText = val + (key === 'gold' || key === 'vix' ? '' : '%');
            if (appState.context === 'custom') updateUI();
        }

        /**
         * Calculation Engine
         * Combines asset returns based on weights to create portfolio curves.
         */
        function calculatePortfolioCurve(portfolioKey, dataContext) {
            const pf = PORTFOLIOS[portfolioKey];
            const comp = pf.composition;
            const years = dataContext.years;
            
            // Start at 100
            let curve = [100];
            
            // For each year step
            for (let i = 1; i < years.length; i++) {
                let yearReturn = 0;
                // Calculate weighted return for this step
                // Growth = (Current / Previous) - 1
                for (const [asset, weight] of Object.entries(comp)) {
                    let assetKey = asset;
                    if(asset === 'smallCapVal') assetKey = 'stocksUS'; // Proxy for simplicity + alpha logic below
                    
                    const assetPrices = dataContext.assets[assetKey] || dataContext.assets['stocksUS']; // Fallback
                    const prev = assetPrices[i-1];
                    const curr = assetPrices[i];
                    
                    let growth = (curr / prev) - 1;
                    
                    // Add "Alpha" proxies for specific sub-asset classes mentioned
                    if (asset === 'smallCapVal') growth += 0.02; // Small Cap premium
                    
                    yearReturn += growth * weight;
                }
                
                // Rebalance: Apply total return to previous portfolio value
                const newVal = curve[i-1] * (1 + yearReturn);
                curve.push(newVal);
            }
            return curve;
        }

        function generateCustomData() {
            // Generate synthetic curves based on slider params
            // This is a simple procedural generation for the "Custom" mode
            const p = appState.customParams;
            const years = [2024, 2025, 2026, 2027, 2028];
            
            // Inflation impacts bonds negatively, commodities positively
            // Rates impact stocks/bonds negatively
            // VIX impacts volatility
            
            return {
                name: "Escenario Personalizado",
                description: `Simulaci√≥n con Inflaci√≥n al ${p.inflation}%, Tipos al ${p.rates}%, y Oro a $${p.gold}.`,
                years: years,
                context: {
                    inflation: years.map(y => p.inflation + (Math.random() - 0.5)),
                    rates: years.map(y => p.rates),
                    vix: years.map(y => p.vix)
                },
                assets: {
                    stocksUS: simulateAssetPath(100, 5, 0.08 - (p.rates/100) - (p.vix/1000), p.vix/100),
                    stocksIntl: simulateAssetPath(100, 5, 0.07 - (p.rates/100), p.vix/100),
                    bondsLong: simulateAssetPath(100, 5, 0.03 - (p.inflation/100), 0.05), // Inflation hurts bonds
                    bondsShort: simulateAssetPath(100, 5, p.rates/100, 0.01), // Rates help short bonds
                    gold: simulateAssetPath(100, 5, (p.inflation/100) * 1.5, 0.15), // Inflation helps gold
                    commodities: simulateAssetPath(100, 5, (p.inflation/100) * 1.2, 0.20),
                    reits: simulateAssetPath(100, 5, 0.05 - (p.rates/100), 0.15),
                    crypto: simulateAssetPath(100, 5, 0.10, p.vix/50)
                }
            };
        }

        function simulateAssetPath(start, steps, drift, vol) {
            let path = [start];
            for(let i=0; i<steps; i++) {
                let change = drift + (Math.random() * vol * 2 - vol);
                path.push(path[i] * (1 + change));
            }
            return path;
        }

        function updateUI() {
            // 1. Get Data
            let data;
            if (appState.context === 'custom') {
                data = generateCustomData();
            } else {
                data = HISTORICAL_DATA[appState.context];
            }

            // 2. Update Text Info
            document.getElementById('chartTitle').textContent = data.name;
            document.getElementById('periodDescription').textContent = data.description;

            // 3. Prepare Chart Datasets
            let datasets = [];

            // A) Context Indicators (Always present, usually dashed or secondary axis)
            // To make chart readable, we map Inflation/Rates to right axis (y1) or left (y) if comparing growth?
            // Let's use Right Axis for percentages (Inflation, Rates)
            datasets.push({
                label: 'Inflaci√≥n (CPI)',
                data: data.context.inflation,
                borderColor: '#ef4444', // red-500
                borderDash: [5, 5],
                borderWidth: 2,
                yAxisID: 'y1',
                pointRadius: 0,
                tension: 0.4
            });
            datasets.push({
                label: 'Tipos Inter√©s (Fed)',
                data: data.context.rates,
                borderColor: '#64748b', // slate-500
                borderDash: [2, 2],
                borderWidth: 2,
                yAxisID: 'y1',
                pointRadius: 0,
                tension: 0.4
            });

            // B) Portfolios
            let analysisMetrics = [];
            
            appState.selectedPortfolios.forEach(pKey => {
                const curve = calculatePortfolioCurve(pKey, data);
                const pInfo = PORTFOLIOS[pKey];
                datasets.push({
                    label: pInfo.name,
                    data: curve,
                    borderColor: pInfo.color,
                    borderWidth: 3,
                    yAxisID: 'y',
                    pointRadius: 2,
                    tension: 0.2
                });
                analysisMetrics.push({ name: pInfo.name, curve: curve });
            });

            // C) Assets
            appState.selectedAssets.forEach(aKey => {
                const curve = data.assets[aKey];
                const aInfo = ASSET_META[aKey];
                datasets.push({
                    label: aInfo.name,
                    data: curve,
                    borderColor: aInfo.color,
                    borderWidth: 2,
                    yAxisID: 'y',
                    pointRadius: 1,
                    tension: 0.2
                });
                analysisMetrics.push({ name: aInfo.name, curve: curve });
            });

            // 4. Update Chart
            chartInstance.data.labels = data.years;
            chartInstance.data.datasets = datasets;
            chartInstance.update();

            // 5. Update Metrics Table & Legend
            updateMetricsTable(analysisMetrics);
            updateLegend(datasets);
            updateStrategyTip(data.name);
        }

        function calculateCAGR(curve) {
            if (!curve || curve.length < 2) return 0;
            const start = curve[0];
            const end = curve[curve.length - 1];
            const years = curve.length - 1; // approx
            return ((Math.pow(end / start, 1 / years) - 1) * 100).toFixed(2);
        }

        function calculateVol(curve) {
             if (!curve || curve.length < 2) return 0;
             // Calculate periodic returns
             let returns = [];
             for(let i=1; i<curve.length; i++) {
                 returns.push((curve[i] - curve[i-1])/curve[i-1]);
             }
             // Std Dev
             const mean = returns.reduce((a,b)=>a+b,0) / returns.length;
             const variance = returns.reduce((a,b)=>a + Math.pow(b-mean, 2), 0) / returns.length;
             return (Math.sqrt(variance) * 100).toFixed(2); // approximate period volatility
        }

        function updateMetricsTable(items) {
            const tbody = document.getElementById('metricsBody');
            tbody.innerHTML = '';
            
            if(items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-slate-400 italic">Selecciona portafolios o activos</td></tr>';
                return;
            }

            items.forEach(item => {
                const cagr = calculateCAGR(item.curve);
                const vol = calculateVol(item.curve);
                const colorClass = cagr > 0 ? 'text-emerald-600' : 'text-red-600';
                
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors";
                tr.innerHTML = `
                    <td class="py-2 pl-2 font-medium truncate max-w-[100px]">${item.name}</td>
                    <td class="py-2 text-right ${colorClass}">${cagr}%</td>
                    <td class="py-2 pr-2 text-right text-slate-500">${vol}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateLegend(datasets) {
            const container = document.getElementById('indicatorsList');
            container.innerHTML = '';
            datasets.forEach((ds, index) => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between text-xs p-1.5 bg-slate-50 rounded border border-slate-100";
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full" style="background-color: ${ds.borderColor}; opacity: ${ds.borderDash ? 0.5 : 1}"></span>
                        <span class="font-medium text-slate-700">${ds.label}</span>
                    </div>
                    <button class="text-slate-400 hover:text-emerald-600" onclick="toggleDataset(${index})">üëÅÔ∏è</button>
                `;
                container.appendChild(div);
            });
        }

        window.toggleDataset = function(index) {
            const meta = chartInstance.getDatasetMeta(index);
            meta.hidden = meta.hidden === null ? !chartInstance.data.datasets[index].hidden : null;
            chartInstance.update();
        }

        function updateStrategyTip(scenarioName) {
            const tipBox = document.getElementById('strategyTip');
            const tipText = document.getElementById('strategyText');
            
            let tip = "";
            if(scenarioName.includes("1970")) tip = "En entornos de estanflaci√≥n, las acciones y bonos tradicionales suelen correlacionarse a la baja. Activos reales como Oro y Materias Primas son vitales para preservar poder adquisitivo.";
            else if(scenarioName.includes("2008")) tip = "Durante crisis deflacionarias sist√©micas, 'Cash is King' y los bonos del tesoro a largo plazo suelen ofrecer la mejor protecci√≥n (Flight to Quality).";
            else if(scenarioName.includes("2020")) tip = "La volatilidad extrema presenta oportunidades de rebalanceo. Comprar activos deprimidos (Value) cuando el miedo es m√°ximo suele generar altos retornos a medio plazo.";
            else if(scenarioName.includes("Dotcom")) tip = "Evita la concentraci√≥n excesiva en sectores de moda. El Value Investing y la diversificaci√≥n geogr√°fica ayudaron a mitigar el colapso tecnol√≥gico.";
            else tip = "En el entorno actual (2025-2026), la vigilancia sobre la inflaci√≥n persistente sugiere mantener cierta exposici√≥n a Oro/Commodities dentro de un portafolio diversificado como el Pinwheel o Golden Butterfly.";

            tipText.textContent = tip;
            tipBox.classList.remove('hidden');
        }

        function toggleGlossary() {
            const el = document.getElementById('glossaryModal');
            el.classList.toggle('hidden');
        }

        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { display: false }, // Custom legend used
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1e293b',
                            bodyColor: '#475569',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        if(context.dataset.yAxisID === 'y1') {
                                            label += context.parsed.y + '%';
                                        } else {
                                            label += Math.round(context.parsed.y);
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8', font: { size: 10 } }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Crecimiento (Base 100)', color: '#94a3b8', font: {size: 10} },
                            grid: { color: '#f1f5f9' },
                            ticks: { color: '#64748b' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Indicadores % (Inflaci√≥n/Tipos)', color: '#ef4444', font: {size: 10} },
                            grid: { drawOnChartArea: false }, // only want the grid lines for one axis to show up
                            ticks: { color: '#ef4444' }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
